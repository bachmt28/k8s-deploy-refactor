# ================================================================================================== #
# NOTE: ðŸ”´ (REQUIRED). Báº®T BUá»˜C ÄIá»€N CHÃNH XÃC 
# TUá»² CHá»ˆNH TUá»² WORKLOAD VÃ€ MÃ”I TRÆ¯á»œNG: ðŸ”¶ (OPTIONAL) Náº¿u muá»‘n Ä‘á»‹nh nghÄ©a rÃµ rÃ ng hÆ¡n. KhÃ´ng báº¯t buá»™c                           #
# ================================================================================================== #
## Metadata
# =========
env: "dev"                    # ðŸ”´ ex: live, pilot, uat, dev, test
appLabel: ""                  # ðŸ”´ Äá»‘i vá»›i AM. ðŸ”¶ Dev/Test náº¿u Ä‘á»ƒ trá»‘ng "", trong cicd sáº½ Ä‘c fail-safe vá» tÃªn git repo. Khai bÃ¡o cá»¥ thá»ƒ náº¿u muá»‘n overrite
version: "rd"                 # ðŸ”´ ex: stable, rd, v1, v2, hotfix, newgen, ... tuá»³ !
system: "sys"                     # ðŸ”¶ ÄÃ¡nh nhÃ£n lÃ  thuá»™c há»‡ thá»‘ng nÃ o. ex: t24, core, ..
org: "sb"                         # ðŸ”¶ ÄÃ¡nh nhÃ£n thuá»™c tá»• chá»©c nÃ o sb | ptf | asean
commonLabels: {}                  # ðŸ”¶ ÄÃ¡nh nhÃ£n tuá»³ chá»‰nh
commonAnnotations: {}             # ðŸ”¶ ÄÃ¡nh nhÃ£n tuá»³ chá»‰nh
labeling:
  prefix: "context.platform.io/"
## WORKLOAD MAIN
# ===============
workload:
  kind: Deployment    # ðŸ”´ Deployment | StatefulSet
  nodeSelector:       # ðŸ”´ PhÃ¢n loáº¡i workload vÃ o node pool
    app: sbapi
  tolerations:        # ðŸ”´ PhÃ¢n loáº¡i workload vÃ o node pool
  - key: app
    value: non-system
    operator: Equal
    effect: NoSchedule

  replicas: 1
  ordinals:
    start: 100
  revisionHistoryLimit: 5

  # Workload Affinity
  affinity: {}
  podAnnotations: {} # ðŸ”¶ Má»™t sá»‘ workload pháº£i cÃ³ annotation má»›i cÃ³ thá»ƒ váº­n hÃ nh tá»‘t
  # proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
  
  hostAliases: []
  volumes:
    - name: tmp
      emptyDir: {}

  specs:
    image:
      repository: "dev-vhht-docker.seauat.com.vn"     # ðŸ”´ Repo lÆ°u trá»¯ image
      name: ""                                        # ðŸ”´ Báº¯t buá»™c vá»›i AM, # ðŸ”¶ Dev chá»‰ cáº§n "" -> trong cicd sáº½ Ä‘Æ°á»£c fail-safe vá» giÃ¡ trá»‹ cá»§a pipeline cicd sau khi build thÃ nh cÃ´ng. 
      tag: ""                                         # ðŸ”´ Báº¯t buá»™c vá»›i AM, # ðŸ”¶ Dev chá»‰ cáº§n "" -> trong cicd sáº½ Ä‘Æ°á»£c fail-safe vá» giÃ¡ trá»‹ cá»§a pipeline cicd sau khi build thÃ nh cÃ´ng. 
      pullPolicy: IfNotPresent # ðŸ”¶ IfNotPresent | Always | Never
    command: []       # ðŸ”¶ Field Ä‘á»ƒ khá»Ÿi cháº¡y workload 
    args: []          # ðŸ”¶ Field Ä‘á»ƒ khá»Ÿi cháº¡y workload 
    env: []           # ðŸ”¶ ThÃ´ng thÆ°á»ng lÃ  Ä‘á»ƒ trá»‘ng, Ä‘iá»n náº¿u muá»‘n custom. Pháº§n nÃ y Ä‘Ã£ Ä‘Æ°á»£c tuá»³ biáº¿n sÃ¢u á»Ÿ pháº§n configmap
    envFrom: []       # ðŸ”¶ ÄÃ£ cÃ³ tÃ­nh nÄƒng auto mount á»Ÿ khai bÃ¡o configmap. Náº¿u muá»‘n inject thÃªm custom thÃ¬ khai bÃ¡o thÃªm
    # - configMapRef:
    #     name: "custom-config-map" # ðŸ”¶ ThÃ´ng thÆ°á»ng lÃ  Ä‘á»ƒ trá»‘ng, Ä‘iá»n náº¿u muá»‘n custom. Pháº§n nÃ y Ä‘Ã£ Ä‘Æ°á»£c tuá»³ biáº¿n sÃ¢u á»Ÿ pháº§n configmap
    ports:
      - name: http
        containerPort: 80 # ðŸ”´ ChÃº Ã½ mapping port chuáº©n xÃ¡c vá»›i service
        protocol: TCP
    resources: # ðŸ”¶ Cáº¥p phÃ¡t resource cho workload
      requests:
        cpu: "100m"
        memory: 128Mi
      limits:
        cpu: "500m"
        memory: 512Mi

    volumeMounts:
      - name: tmp
        mountPath: /tmp


## ADVANCED # ðŸ”¶ CÃ¡c tuá»³ chá»‰nh sÃ¢u hÆ¡n cho workload
    livenessProbe: {}
      # httpGet:
      #   path: /healthz
      #   port: 9898
      # initialDelaySeconds: 5
      # periodSeconds: 10     
    readinessProbe: {}
      # httpGet:
      #   path: /readyz
      #   port: 9898
      # initialDelaySeconds: 2
      # periodSeconds: 5
    startupProbe: {}
    securityContext:
      allowPrivilegeEscalation: false
      runAsNonRoot: false
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop: ["ALL"]


  # Deployment strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 0
  # StatefulSet updateStrategy
  statefulSetUpdateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0
  terminationGracePeriodSeconds: 30

  # Labels/Annotations cho Pod (khÃ´ng áº£nh hÆ°á»Ÿng selector)
  podLabels: {}
  topologySpreadConstraints: []   # vÃ­ dá»¥: phÃ¢n bá»‘ theo zone/hostname
  podSecurityContext:
    runAsNonRoot: false
    fsGroup: 2000
  priorityClassName: ""
  dnsConfig: {}
  automountServiceAccountToken: false   # khuyáº¿n nghá»‹ an toÃ n máº·c Ä‘á»‹nh
  imagePullSecrets: [ name: nexus-repo-secret ]

  # Khai bÃ¡o thÃªm container phá»¥
  initContainers: []
  sidecars: []

## ==== CONFIGMAP  ==== ##
# Khi ConfigMap thay Ä‘á»•i template workload cÃ³ annotation check sum Ä‘á»ƒ tá»± Ä‘á»™ng rollout restart 
# ===========================================================================================
configMap:
  env:
    enabled: true           # ðŸ”¶ true | false => táº¡o CM cho envFrom
    name: ""                # "" => <workload fullname>-env
    autoMount: true         # true => náº¿u user KHÃ”NG khai bÃ¡o envFrom thá»§ cÃ´ng thÃ¬ chart tá»± thÃªm envFrom CM nÃ y
    data:                   # ðŸ”¶ dáº¡ng Keyvalue: key: value
      TZ: Asia/Ho_Chi_Minh

  file:
    enabled: true           # ðŸ”¶ true | false => táº¡o CM Ä‘á»ƒ mount tá»«ng file
    data:                   # ðŸ”¶ Ná»™i dung cá»§a tá»«ng file
      app.js: |               
        789
        456123123
      new.txt: |
        oiasidfjasf
        Ã¡dfjaisodfjoi
        
    mounts:
      - key: app.js
        mountPath: /opt/config/app.js     # ðŸ”¶ â† Báº®T BUá»˜C KHAI FULL PATH Náº¾U CÃ“
        readOnly: true
      - key: new.txt
        mountPath: /etc/doc/new.txt      # ðŸ”¶ â† Báº®T BUá»˜C KHAI FULL PATH Náº¾U CÃ“
        readOnly: false

## ====PERSISTENCE VOLUME CLAIM ==== ##
# ====================================#
pvc:
  enabled: false
  claimName: "" # ðŸ”¶ Náº¿u dÃ¹ng PVC sáºµn cÃ³ â†’ Ä‘iá»n claimName (Æ°u tiÃªn dÃ¹ng claimName overrite). KhÃ´ng dÃ¹ng default theo tÃªn chart
  # Náº¿u táº¡o PVC má»›i: # ðŸ”¶ claimName "" sáº½ kiá»ƒm tra vÃ o táº¡o má»›i (náº¿u chÆ°a) theo tÃªn chart 
  storageClassName: "standard-rwo"
  accessModes:
    - ReadWriteOnce
  labels: {}
  persistentVolumeClaim:
    requests:
      storage: 5Gi

## SERVICE 
# =========
service:
  enabled: true
  type: ClusterIP
  annotations: {}
  name: ""               # "" -> máº·c Ä‘á»‹nh = <workload fullname>
  ports:
    - name: http
      port: 80
      targetPort: 80    # ðŸ”´ ChÃº Ã½ mapping port chuáº©n xÃ¡c vá»›i service
  headlessEnabled: true
  headlessName: ""       # "" -> máº·c Ä‘á»‹nh = <workload fullname>-headless


# ================================================================================================== #
# NOTE: RIÃŠNG PHáº¦N SECRET Sáº¼ KHÃ”NG ÄÆ¯á»¢C ÄÆ¯A VÃ€O HELM Äá»‚ Táº O THEO MAINIFEST, VÃŒ THEO TIÃŠU CHUáº¨N ANNT  #
# USER CHá»¦ Äá»˜NG Tá»° Táº O THá»¦ CÃ”NG TRÃŠN RANCHER HOáº¶C KUBECTL                                            #     
# SAU ÄÃ“ KHAI BÃO MOUNT TRONG PHáº¦N SPECS Cá»¦A WORKLOAD                                                # 
# TÆ¯Æ NG LAI Sáº¼ QUY HOáº CH SANG Sá»¬ Dá»¤NG KEYSTORE NHÆ¯ VAULT                                             #
# ================================================================================================== #

## HPA
# ====
hpa:
  enabled: false
  minReplicas: 1
  maxReplicas: 2
  metrics: # ðŸ”¶ GiÃ¡ trá»‹ bÃªn dÆ°á»›i lÃ  tiÃªu chuáº©n thÆ°á»ng tháº¥y cho HPA
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 75
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior: {} # ðŸ”¶ NÃ¢ng cao hÆ¡n cá»§a HPA
  # vÃ­ dá»¥:
  # behavior:
  #   scaleUp:
  #     stabilizationWindowSeconds: 30
  #     policies:
  #       - type: Percent
  #         value: 100
  #         periodSeconds: 60
  #   scaleDown:
  #     stabilizationWindowSeconds: 300
  #     policies:
  #       - type: Percent
  #         value: 100
  #         periodSeconds: 60


## SERVICE ACCOUNT
# =================
serviceAccount: # ðŸ”¶ Náº¿u ko cÃ³ nhu cáº§u tuá»³ biáº¿n cao hÆ¡n Ä‘á»ƒ nhÆ° máº·c Ä‘á»‹nh
  create: false
  name: ""               # "" -> máº·c Ä‘á»‹nh = <workload fullname>
  annotations: {}

# POD DISRUPTOR BUDGET
# =====================
pdb: # ðŸ”¶ Náº¿u ko cÃ³ nhu cáº§u tuá»³ biáº¿n cao hÆ¡n Ä‘á»ƒ nhÆ° máº·c Ä‘á»‹nh, pháº§n nÃ y chá»‰ quan trá»ng vá»›i >=uat, dev/test khuyáº¿n cÃ¡o Ä‘á»ƒ enable false
  enabled: false
  maxAvailable: 1
