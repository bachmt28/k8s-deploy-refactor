{{- /* Fail sớm nếu thiếu giá trị bắt buộc */ -}}
{{- define "workload.validate" -}}
  {{- $chartLabel := trim (default "" .Values.chartLabel) -}}
  {{- if not $chartLabel -}}
    {{- fail "values.chartLabel is required" -}}
  {{- end -}}

  {{- $env := trim (default "" .Values.env) -}}
  {{- if not $env -}}
    {{- fail "values.env is required (labels only)" -}}
  {{- end -}}

  {{- /* DNS-1123 regex for chartLabel and fullname */ -}}
  {{- $dnsre := "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$" -}}
  {{- if not (regexMatch $dnsre $chartLabel) -}}
    {{- fail (printf "values.chartLabel must match DNS-1123: %q" $chartLabel) -}}
  {{- end -}}


  {{- if eq (.Values.workload.kind | default "Deployment") "StatefulSet" -}}
    {{- $site := trim (default "" .Values.site) -}}
    {{- if not $site -}}
      {{- fail "values.site is required when workload.kind=StatefulSet (labels only)" -}}
    {{- end -}}
  {{- end -}}

  {{- /* Kiểm tra độ dài metadata.name theo rule: .Release.Name + '-' + chartLabel */ -}}
  {{- $fn := printf "%s-%s" .Release.Name $chartLabel -}}
  {{- if gt (len $fn) 63 -}}
    {{- fail (printf "metadata.name too long (>63): %d chars. Current: %q" (len $fn) $fn) -}}
  {{- end -}}
  {{- if not (regexMatch $dnsre $fn) -}}
    {{- fail (printf "fullname must match DNS-1123: %q" $fn) -}}
  {{- end -}}

{{- end -}}

{{- /* Trigger validation early; produces no YAML */ -}}
{{- include "workload.validate" . -}}

{{- /* Bảo đảm StatefulSet có serviceName hợp lệ */ -}}
{{- if eq (.Values.workload.kind | default "Deployment") "StatefulSet" -}}
  {{- if not (or .Values.service.headlessEnabled .Values.service.enabled) -}}
    {{- fail "StatefulSet requires service.headlessEnabled=true or service.enabled=true" -}}
  {{- end -}}
{{- end -}}
